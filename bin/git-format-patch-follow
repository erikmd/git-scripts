#!/usr/bin/env bash
# Copyright (c) 2017 Erik Martin-Dorel

set -euo pipefail

function die_hard() {
    echo -e "$@" >&2
    exit 1
}

function main() {
    local arg
    local follow
    local skip=''
    local args=()
    for arg; do
        case "$arg" in
            "--")
                die_hard "'-- [filenames]' arguments are not allowed"
                ;;
            "--follow")
                if [[ $# -lt 2 ]]; then
                    die_hard "'--follow' expects one argument"
                else
                    follow="$2"
                    skip='true'
                    shift 2
                fi
                ;;
            *)
                if [[ $skip = 'true' ]]; then
                    skip=''
                else
                    args[${#args[@]}]="$arg"
                    shift
                fi
                ;;
        esac
    done
    # $follow is the single file to follow
    # ${args[@]} is the rest of arguments
    local file
    local files=()
    while read -r -d $'\0' file; do
        files[${#files[@]}]="$file"
    done < <(git log -z --name-only --format="format:" --follow "$follow" | tr -s '\0' | sort -u -z)
    # ${files[@]} is the list of files related (w.r.t. renaming) to $follow
    git format-patch "${args[@]}" -- "${files[@]}"
}

main "$@"
