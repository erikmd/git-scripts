#!/usr/bin/env bash
# Copyright (c) 2017 Erik Martin-Dorel
ts="Time-stamp: <2017-10-08 00:32:42 emartin>"; ts=${ts#Time-stamp: }
set -euo pipefail

function die_hard() {
    echo -e "$@" >&2
    exit 1
}

function usage() {
    cat >&2 <<EOF
git-format-patch-follow $ts

Facility to export the Git history of given files, including renames.

Usage:
$ git format-patch-follow <options> --follow <path1> [--follow <path2>] ...

Example:
$ git format-patch-follow --stdout --root --follow 1.txt > patch
$ git format-patch-follow --stdout --root --follow 1.txt --follow 2.txt > patch
EOF
}

function main() {
    local arg
    local follow=''
    local skip=''
    local args=()
    if [[ $# = 0 ]]; then
        usage
        exit 0
    fi
    local file
    local files=()
    for arg; do
        case "$arg" in
            "--")
                die_hard "Error: '-- [filenames]' arguments are not allowed."
                ;;
            "--follow")
                if [[ $# -lt 2 ]]; then
                    die_hard "Error: '--follow' expects one argument."
                else
                    follow="$2"
                    skip='true'
                    shift 2
                    # $follow is the file to follow
                    while read -r -d $'\0' file; do
                        files+=("$file")
                    done < <(git log -z --name-only --format="format:" --follow "$follow" | tr -s '\0' | sort -u -z)
                fi
                ;;
            "--help")
                usage
                exit 0
                ;;
            *)
                if [[ $skip = 'true' ]]; then
                    skip=''
                else
                    args+=("$arg")
                    shift
                fi
                ;;
        esac
    done
    # ${args[@]} is the list of arguments except those bound to --follow
    # ${files[@]} is the list of files to consider in the history export
    git format-patch "${args[@]}" -- "${files[@]}"
}

main "$@"
